\documentclass[11pt,letterpaper]{article}

% Load package
\usepackage{lesson}

%--------------------------------------%
% Custom commands include:             %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Include an image:                    %
% \diagram{height}{align}{file}        %
%                                      %
% height: a number representing mm     %
% align: left, center, or right        %
% file: file name without extension    %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Add a numbered question:             %
% \question{text}                      %
% \questiond[lines]{file}{width}{text} %
%                                      %
% lines: # of lines of text to wrap    %
% file: file name without extension    %
% width: a % of textwidth for image    %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Add a lettered option/question part: %
% \option[vspace]{text}                %
%                                      %
% vspace: added space above the option %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Add a blank line in text:            %
% \blankline{width}                    %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Add an arc symbol in math:           %
% \arc{notation}                       %
%--------------------------------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%--------------------------------------%
% To reset the question counter:       %
% \setcounter{qcounter}{0}             %
%                                      %
% To reset the option counter:         %
% \setcounter{acounter}{0}             %
%--------------------------------------%

% Set title and course name
\settitle{\textbf{1}}
\setsubtitle{}
\setcourse{EE2003}

\begin{document}

% Create title and add proper header for first page
\maketitle
\thispagestyle{first}
\section*{Intel 8086}
\diagram{70}{center}{8086.jpg}
\subsection*{Execution Unit}
\begin{itemize}
	\item Flag register used to store some result about an operation. Example
		result of a comparision or overflow bit etc. Used by the ALU
	\item E(xtended)SP: Stack pointer
	\item EA/B/C/D: General registers. Do whatever you want
	\item ESI/ EDI: For string instructions. strlen() or memcpy()
\end{itemize}

The Extended registers \textbf{extend} the A/B/C/DX registers to 32 bit

\subsection*{Bus Interface Unit}
\textbf{CS, SS, DS} store the starting address of code, stack and data segments.
The IP(instruction pointer) or the {A,B,C,D} registers are used to store the offset from the start address.
Formula is given by:  \[Address = Segment << 4 + offset\]

BP and SP point to SS, IP points to CS, A/B/C/D point to DS (or ES, prof did not remember)


\settitle{\textbf{2}}
\subsection*{x86 Ops}
\begin{minted}[linenos,frame=single]{nasm}
MOV EAX, EBX       ; EAX <- EBX, register direct
MOV EAX, [ECX]     ; Load from memory, register indirect
MOV [ECX], EAX     ; store to memory
MOV EAX, [EBX - N] ; register indirect with offset, requires the EDS as well
MOV EAX, 0x1602    ; immediate mode, no address calculation required
MOV EAX, EBX - ECX ; THIS IS WRONG


; Load Effective Addr:
; Essentially you can do math in the right operand.
; Used in compilers for things like
; int *p = &point[i].ycoord;
LEA EAX, [EBP+8*EAX+4]

; ALU Ops
ADD EAX, EBX	; EAX <- EAX + EBX
SUB EAX, DWORD PTR[EBX]
SUB EAX, WORD PTR[EBX]
SUB EAX, BYTE PTR[EBX]

; Logical Ops
AND EAX, DWORD PTR [EBP + 4]
\end{minted}

\question{
Write assembly to do the following:
\newline
$EAX = x*y + a-b$
\newline
$EBX = (x \oplus y) | (a \wedge b)$
}

\begin{minted}[linenos,frame=single]{nasm}
; first part
MOV EAX, X
MUL y
MOV EBX, a
SUB EBX, b
ADD EAX, EBX

;second part
MOV EBX, x
XOR EBX, y
MOV ECX, a
AND ECX, b
OR EBX, ECX
\end{minted}

\pagebreak
\question{Write a program to evaluate $z = x * y$ using repeated addition}
\begin{minted}[linenos, frame=single]{nasm}
XOR EAX, EAX
MOV EBX, y
CMP EBX, 0
JZ done
add:	
ADD EAX, x
DEC EBX
JNZ add

done:
NOP
\end{minted}
\question{Write a program to calculate the string length of a constant string}
\begin{minted}[linenos, frame=single]{nasm}
; assuming the data is little endian
XOR EAX, EAX
loop: 
CMP [EBX], 0
JZ done
INC EBX
INC EAX
JMP loop

done:
NOP
\end{minted}

\question{Write a program to swap two integers x and y}
\begin{minted}[linenos, frame=single]{c}
Swap(int *pX, int *pY){
	__asm{
		MOV EAX, pX
		MOV EBX, pY

		PUSH DWORD PTR [EAX]
		PUSH DWORD PTR [EBX]
		POP DWORD PTR [EAX]
		POP DWORD PTR [EBX]
	}
}
\end{minted}

\pagebreak

\question{Look at these swaps and realize the differences}
\begin{minted}[linenos, frame=single]{c}
Swap(int *pX, int *pY){
	__asm{
		; this thing is like gae
		; the most useless thing ever
		PUSH pX
		PUSH pY
		POP pX
		POP pY
	}
}

Swap2(int x, int y){
	__asm{
		; this thing is like gae
		; the most useless thing ever
		PUSH x 
		PUSH y 
		POP x
		POP y
	}
}
\end{minted}


\section*{Compiling a C program}
\subsection*{Optimizing}
You can optimize youc \texttt{*.c} code by using the \texttt{\textbackslash O1} flag if using MSVC

It removes dead code and can optimize to reduce intstructions. However one should
be very careful and not trust the compiler to do their job perfectly all the time.

\end{document}

